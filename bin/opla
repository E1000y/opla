#!/usr/bin/env node
const chalk = require("chalk");
const figlet = require("figlet");
const fs = require("fs-extra");
const pkg = require("../package.json");
const program = require("commander");
const { prompt } = require("inquirer");

const CONFIG_FILE = "config/default.json";
const DB_MIGRATE_CONFIG_FILE = "config/db-migrate.json";
const DESCRIPTION = `Management tool for ${pkg.description}`;

program
  .version(pkg.version)
  .description(DESCRIPTION)
  .option("--non-interactive", "Do not prompt and use default settings");

const configDefaults = {
  databaseType: "mysql",
  databaseHost: "127.0.0.1",
  databaseName: "opla_dev",
  databaseUser: "root",
  databasePass: "",
  apiEndpoint: "/api",
  authEndpoint: "/auth",
};

program
  .command("init")
  .alias("i")
  .description("Initialize the project and create the configuration file")
  .option("--database-name [name]", "The database name", configDefaults.databaseName)
  .action(async (options) => {
    const questions = [
      {
        type: "list",
        name: "databaseType",
        message: "Database engine",
        choices: ["mysql"],
        default: [configDefaults.databaseType],
      },
      {
        type: "input",
        name: "databaseHost",
        message: "Database host",
        default: configDefaults.databaseHost,
      },
      {
        type: "input",
        name: "databaseName",
        message: "Database name",
        default: options.databaseName,
      },
      {
        type: "input",
        name: "databaseUser",
        message: "Database user",
        default: configDefaults.databaseUser,
      },
      {
        type: "password",
        name: "databasePass",
        message: "Database password",
        default: configDefaults.databasePass,
      },
      {
        type: "input",
        name: "apiEndpoint",
        message: "Main API endpoint",
        default: configDefaults.apiEndpoint,
      },
      {
        type: "input",
        name: "authEndpoint",
        message: "Auth API endpoint",
        default: configDefaults.authEndpoint,
      },
    ];

    try {
      const fileExists = await fs.pathExists(CONFIG_FILE);

      if (fileExists) {
        questions.push(
          {
            type: "confirm",
            name: "overwrite",
            message:
            "The configuration files already exist. Do you want to overwrite them?",
            default: false,
          },
        );
      }

      let answers;
      if (program.nonInteractive) {
        answers = {
          ...configDefaults,
          databaseName: options.databaseName,
        };
      } else {
        answers = await prompt(questions);
      }

      if (fileExists && !answers.overwrite) {
        return;
      }

      // create the configuration
      const config = {
        name: "Opla.ai",
        version: pkg.version,
        global: {
          database: {
            datatype: answers.databaseType,
            host: answers.databaseHost,
            name: answers.databaseName,
            user: answers.databaseUser,
            password: answers.databasePass,
            charset: "utf8mb4",
            version: "2",
          },
          api: {
            endpoint: answers.apiEndpoint,
            version: "1",
            port: 8081,
          },
          botSite: {
            url: "http://127.0.0.1:8085/?b=",
          },
        },
        auth: {
          database: {
            parent: "global",
            name: "auth",
          },
          api: {
            endpoint: answers.authEndpoint,
          },
        },
        messenger: {
          database: {
            parent: "global",
            name: "messenger",
          },
        },
        users: {
          database: {
            parent: "global",
            name: "users",
          },
        },
        bots: {
          database: {
            parent: "global",
            name: "bots",
          },
        },
        webhooks: {
          database: {
            parent: "global",
            name: "webhooks",
          },
        },
        middlewares: {
          database: {
            parent: "global",
            name: "middlewares",
          },
        },
        parameters: {
          database: {
            parent: "global",
            name: "parameters",
          },
        },
      };

      // create configuration for "db-migrate" tool
      // see: http://db-migrate.readthedocs.io/en/latest/Getting%20Started/configuration/
      const dbMigrateConfig = {
        defaultEnv: "local",
        "sql-file": true,
        local: {
          driver: answers.databaseType,
          host: answers.databaseHost,
          database: answers.databaseName,
          user: answers.databaseUser,
          password: answers.databasePass,
          multipleStatements: true,
        },
      };

      await fs.writeJson(CONFIG_FILE, config, { spaces: 2 });
      await fs.writeJson(DB_MIGRATE_CONFIG_FILE, dbMigrateConfig, {
        spaces: 2,
      });

      console.log(chalk.green("Project successfully configured!"));
    } catch (err) {
      const errorMessage = err.message;
      console.error(chalk.red(`An error has occured: ${errorMessage}`));
    }
  });

console.log(
  chalk.yellow(figlet.textSync("Opla CE", { horizontalLayout: "full" })),
);
console.log(`${DESCRIPTION}\n`);

program.parse(process.argv);

if (!program.args.length) {
  program.help();
}
